<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Laberinto Móvil Mejorado</title>
<style>
body { margin:0; font-family:sans-serif; display:flex; flex-direction:column; align-items:center; background:#f0f0f0; }
canvas { background:#eee; display:block; margin:10px 0; border:2px solid #333; }
#info { font-size:18px; margin-bottom:5px; text-align:center; }
#controls { display:flex; flex-direction:column; align-items:center; gap:10px; margin-bottom:10px; }
button { font-size:18px; padding:8px 12px; border-radius:6px; }
.control-btns { display:grid; grid-template-columns: repeat(3, 60px); gap:5px; justify-content:center; }
#upload { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; }
</style>
</head>
<body>
<h1>Laberinto XL</h1>

<div id="info">
  Tiempo: <span id="time">0</span> s | 
  Nivel: <span id="level">1</span> | 
  Velocidad: <span id="speed">0</span> | 
  Vidas: <span id="lives">3</span>
</div>

<canvas id="game"></canvas>

<div id="controls">
  <div id="upload">
    <label>Jugador: <input type="file" id="playerUpload" accept="image/*"></label>
    <label>Perseguidor: <input type="file" id="chaserUpload" accept="image/*"></label>
  </div>
  <div class="control-btns">
    <div></div><button id="up">↑</button><div></div>
    <button id="left">←</button><div></div><button id="right">→</button>
    <div></div><button id="down">↓</button><div></div>
  </div>
  <div style="display:flex; gap:10px; justify-content:center;">
    <button id="startBtn">Start</button>
    <button id="resetBtn">Reset</button>
    <button id="regenBtn">Regenerar Laberinto</button>
  </div>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const cols = 12;  
const rows = 12;  
let canvasSize = Math.min(window.innerWidth-20, window.innerHeight*0.6);
canvas.width = canvasSize;
canvas.height = canvasSize;
let size = canvas.width / cols;

let maze = [];
let player = {x:1,y:1};
let chaser = {x:cols-2,y:rows-2};
let goal = {x:cols-2,y:1};
let time = 0;
let level = 1;
let gameStarted = false;
let loseCount = 0;
let lives = 3;

let chaserSpeed = 20;
let chaserCounter = 0;

let playerImg = new Image();
let chaserImg = new Image();

window.addEventListener("resize", ()=>{
  canvasSize = Math.min(window.innerWidth-20, window.innerHeight*0.6);
  canvas.width = canvasSize;
  canvas.height = canvasSize;
  size = canvas.width / cols;
  draw();
});

// Subida de imágenes
document.getElementById("playerUpload").addEventListener("change", function(e){
  const file = e.target.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = function(ev){ playerImg.src = ev.target.result; }
    reader.readAsDataURL(file);
  }
});
document.getElementById("chaserUpload").addEventListener("change", function(e){
  const file = e.target.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = function(ev){ chaserImg.src = ev.target.result; }
    reader.readAsDataURL(file);
  }
});

// Generar laberinto
function generateMaze(){
  maze = [];
  for(let y=0;y<rows;y++){
    maze[y]=[];
    for(let x=0;x<cols;x++){
      maze[y][x] = Math.random() < 0.2 ? 1 : 0;
    }
  }
  maze[player.y][player.x]=0;
  maze[chaser.y][chaser.x]=0;
  maze[goal.y][goal.x]=0;
}

// Dibujar laberinto y personajes
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(let y=0;y<rows;y++){
    for(let x=0;x<cols;x++){
      if(maze[y][x]==1) ctx.fillStyle="black", ctx.fillRect(x*size,y*size,size,size);
    }
  }
  ctx.fillStyle="green"; ctx.fillRect(goal.x*size, goal.y*size, size, size);
  
  // Jugadores tamaño igual a celda
  if(playerImg.complete && playerImg.src) ctx.drawImage(playerImg, player.x*size, player.y*size, size, size);
  else ctx.fillStyle="blue", ctx.fillRect(player.x*size, player.y*size, size, size);
  if(chaserImg.complete && chaserImg.src) ctx.drawImage(chaserImg, chaser.x*size, chaser.y*size, size, size);
  else ctx.fillStyle="red", ctx.fillRect(chaser.x*size, chaser.y*size, size, size);
}

// Movimiento jugador
function movePlayer(dx,dy){
  if(!gameStarted) return;
  let nx = player.x+dx, ny = player.y+dy;
  if(nx>=0 && nx<cols && ny>=0 && ny<rows && maze[ny][nx]==0){
    player.x=nx; player.y=ny; checkGoal();
  }
}

// Meta
function checkGoal(){
  if(player.x==goal.x && player.y==goal.y){
    level++;
    document.getElementById("level").innerText = level;
    alert("¡Nivel completado!");
    nextLevel();
  }
}

// Siguiente nivel
function nextLevel(){
  loseCount = 0; lives=3;
  document.getElementById("regenBtn").disabled = false;
  document.getElementById("lives").innerText = lives;
  if(level%5===0 && chaserSpeed>5) chaserSpeed-=2;
  document.getElementById("speed").innerText = 25 - chaserSpeed;
  goal.x = Math.floor(Math.random()*cols);
  goal.y = Math.floor(Math.random()*rows);
  while(maze[goal.y][goal.x]==1){
    goal.x = Math.floor(Math.random()*cols);
    goal.y = Math.floor(Math.random()*rows);
  }
  player={x:1,y:1};
  chaser={x:cols-2,y:rows-2};
  generateMaze();
}

// Reset completo
function fullReset(){
  level=1; chaserSpeed=20; time=0; loseCount=0; lives=3;
  document.getElementById("regenBtn").disabled = false;
  document.getElementById("level").innerText = level;
  document.getElementById("speed").innerText = 25 - chaserSpeed;
  document.getElementById("time").innerText = time;
  document.getElementById("lives").innerText = lives;
  player={x:1,y:1}; chaser={x:cols-2,y:rows-2};
  generateMaze();
}

// Tiempo
setInterval(()=>{ if(gameStarted){ time++; document.getElementById("time").innerText=time; } },1000);

// BFS perseguidor
function bfs(start,target){
  let queue=[{x:start.x,y:start.y,path:[]}];
  let visited = Array.from({length:rows}, ()=>Array(cols).fill(false));
  visited[start.y][start.x]=true;
  while(queue.length>0){
    let curr = queue.shift();
    if(curr.x==target.x && curr.y==target.y) return curr.path;
    let moves = [{x:0,y:-1},{x:0,y:1},{x:-1,y:0},{x:1,y:0}];
    for(let m of moves){
      let nx=curr.x+m.x, ny=curr.y+m.y;
      if(nx>=0 && nx<cols && ny>=0 && ny<rows && maze[ny][nx]==0 && !visited[ny][nx]){
        visited[ny][nx]=true;
        queue.push({x:nx,y:ny,path:curr.path.concat([{x:nx,y:ny}])});
      }
    }
  }
  return [];
}

// Perseguidor
function moveChaser(){
  if(!gameStarted) return;
  chaserCounter++;
  if(chaserCounter % chaserSpeed !==0) return;
  let path=bfs(chaser,player);
  if(path.length>0){ chaser.x=path[0].x; chaser.y=path[0].y; }
  if(player.x==chaser.x && player.y==chaser.y){
    alert("¡Te atraparon!");
    gameStarted=false;
    loseCount++;
    lives--;
    document.getElementById("lives").innerText = lives;
    if(loseCount>=3){
      document.getElementById("regenBtn").disabled = true;
      alert("¡Ya no puedes regenerar el laberinto, perdiste 3 veces!");
    }
  }
}

// Controles
document.getElementById("up").onclick = ()=>movePlayer(0,-1);
document.getElementById("down").onclick = ()=>movePlayer(0,1);
document.getElementById("left").onclick = ()=>movePlayer(-1,0);
document.getElementById("right").onclick = ()=>movePlayer(1,0);
document.addEventListener("keydown",(e)=>{
  if(e.key=="ArrowUp") movePlayer(0,-1);
  if(e.key=="ArrowDown") movePlayer(0,1);
  if(e.key=="ArrowLeft") movePlayer(-1,0);
  if(e.key=="ArrowRight") movePlayer(1,0);
});

// Botones
document.getElementById("startBtn").addEventListener("click", ()=>{ if(!gameStarted){ gameStarted=true; alert("¡Juego iniciado!"); } });
document.getElementById("resetBtn").addEventListener("click", ()=>{ fullReset(); gameStarted=false; });
document.getElementById("regenBtn").addEventListener("click", ()=>{
  if(lives>0){
    player={x:1,y:1};
    chaser={x:cols-2,y:rows-2};
    goal={x:cols-2,y:1};
    generateMaze();
    draw();
    alert("Nuevo laberinto generado para este nivel.");
  }
});

generateMaze();
draw();

function gameLoop(){ moveChaser(); draw(); requestAnimationFrame(gameLoop); }
gameLoop();
</script>
</body>
</html>
